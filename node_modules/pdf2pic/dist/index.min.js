"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}require("@babel/polyfill"),require("gm-base64");var gm=_interopDefault(require("gm")),path=_interopDefault(require("path")),fs=_interopDefault(require("fs-extra")),Promise$1=_interopDefault(require("bluebird"));function asyncGeneratorStep(e,t,n,r,a,i,s){try{var o=e[i](s),u=o.value}catch(e){return void n(e)}o.done?t(u):Promise.resolve(u).then(r,a)}function _asyncToGenerator(o){return function(){var e=this,s=arguments;return new Promise(function(t,n){var r=o.apply(e,s);function a(e){asyncGeneratorStep(r,t,n,a,i,"next",e)}function i(e){asyncGeneratorStep(r,t,n,a,i,"throw",e)}a(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}var PDF2Pic=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t),this.options=_objectSpread({},t.defaultOptions,e)}var n,r,a,i,s,o,u,c;return _createClass(t,[{key:"identify",value:function(e,t){var a=gm(e);return new Promise$1(function(n,r){t?a.identify(t,function(e,t){return e?r(e):n(t)}):a.identify(function(e,t){return e?r(e):n(t)})})}},{key:"graphicMagickBaseCommand",value:function(e,t){var n=this.options,r=n.density,a=n.size,i=n.quality,s=n.compression;return gm(e,t).density(r,r).resize(a).quality(i).compress(s)}},{key:"writeImage",value:function(e,r,a,i){var s=this;return new Promise$1(function(t,n){s.graphicMagickBaseCommand(e,a).write(r,function(e){return e?n(e):t({name:path.basename(r),size:fs.statSync(r).size/1e3,path:r,page:i})})})}},{key:"toBase64",value:function(e,t,a){var i=this,s=this.options.format;return new Promise$1(function(n,r){i.graphicMagickBaseCommand(e,t).toBase64(s,function(e,t){return e?r(e):n({base64:t,page:a})})})}},{key:"convert",value:(c=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=1<a.length&&void 0!==a[1]?a[1]:1,this.isValidPDF(t),this.fileExists(t),r=path.basename(t,path.extname(path.basename(t))),this.getOption("savedir")?this.setOption("savedir",this.getOption("savedir")+path.sep):this.setOption("savedir",r+path.sep),fs.mkdirsSync(this.getOption("savedir")),this.getOption("savename")||this.setOption("savename",r),e.next=9,this.getPageCount(t);case 9:if(e.sent<n)throw new Error("Cannot convert non-existent page");e.next=12;break;case 12:return e.next=14,this.toImage(t,n);case 14:return e.abrupt("return",e.sent);case 15:case"end":return e.stop()}},e,this)})),function(e){return c.apply(this,arguments)})},{key:"convertToBase64",value:(u=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=1<a.length&&void 0!==a[1]?a[1]:1,this.isValidPDF(t),this.fileExists(t),r=path.basename(t,path.extname(path.basename(t))),this.getOption("savedir")?this.setOption("savedir",this.getOption("savedir")+path.sep):this.setOption("savedir",r+path.sep),fs.mkdirsSync(this.getOption("savedir")),this.getOption("savename")||this.setOption("savename",r),e.next=9,this.getPageCount(t);case 9:if(e.sent<n)throw new Error("Cannot convert non-existent page");e.next=12;break;case 12:return e.next=14,this.streamToBase64(t,n,!0);case 14:return e.abrupt("return",e.sent);case 15:case"end":return e.stop()}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"convertToBase64Bulk",value:(o=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i=this,s=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=1<s.length&&void 0!==s[1]?s[1]:-1,r=[],a=Array.isArray(n)?n:[1],-1===n)return e.next=6,this.getPage(t);e.next=9;break;case 6:e.t0=e.sent,e.next=10;break;case 9:e.t0=a;case 10:return n=(n=e.t0).map(function(e){return i.convertToBase64(t,e)}),e.next=14,Promise$1.all(n);case 14:return r=e.sent,e.abrupt("return",r);case 16:case"end":return e.stop()}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"convertBulk",value:(s=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i=this,s=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=1<s.length&&void 0!==s[1]?s[1]:-1,r=[],a=Array.isArray(n)?n:[1],-1===n)return e.next=6,this.getPage(t);e.next=9;break;case 6:e.t0=e.sent,e.next=10;break;case 9:e.t0=a;case 10:return n=(n=e.t0).map(function(e){return i.convert(t,e)}),e.next=14,Promise$1.all(n);case 14:return r=e.sent,e.abrupt("return",r);case 16:case"end":return e.stop()}},e,this)})),function(e){return s.apply(this,arguments)})},{key:"getPageCount",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPage(t).length;case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"getPage",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.identify(t,"%p ");case 2:return n=e.sent,e.abrupt("return",n.split(" "));case 4:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"toImage",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i,s,o,u,c,p=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=1<p.length&&void 0!==p[1]?p[1]:1,r=this.getOption(),a=r.savedir,i=r.savename,s=r.format,o=fs.createReadStream(t),u="".concat(a.replace(/\/*$/,"/")).concat(i,"_").concat(n,".").concat(s),c="".concat(this.getFilePath(o),"[").concat(n-1,"]"),e.next=7,this.writeImage(o,u,c,n);case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"streamToBase64",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=1<i.length&&void 0!==i[1]?i[1]:1,r=fs.createReadStream(t),a="".concat(this.getFilePath(r),"[").concat(n-1,"]"),e.next=5,this.toBase64(r,a,n);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"getFilePath",value:function(e){if(!e)throw new Error("Invalid Stream");return e.path}},{key:"isValidPDF",value:function(e){if(".pdf"!==path.extname(path.basename(e)).toLowerCase())throw new Error("File supplied is not a valid PDF");return!0}},{key:"fileExists",value:function(e){if(!fs.existsSync(e))throw new Error("File supplied cannot be found");return!0}},{key:"getOption",value:function(e){return e?this.options[e]:this.options}},{key:"setOption",value:function(e,t){return this.options[e]=t,this}}]),t}();_defineProperty(PDF2Pic,"defaultOptions",{quality:0,format:"png",size:"768x512",density:72,savedir:"./",savename:"untitled",compression:"jpeg"}),module.exports=PDF2Pic;
